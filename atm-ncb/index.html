<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù…Ù†Ø¸ÙˆÙ…Ø© Ø¢Ù„Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø°Ø§ØªÙŠ - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
<style>
  :root{--bg1:#003366;--bg2:#00cc99;--card:rgba(255,255,255,0.10);--card-2:rgba(255,255,255,0.18)}
  body{margin:0;font-family:Tahoma,Arial,Helvetica,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff;min-height:100vh}
  .wrap{display:flex;align-items:flex-start;justify-content:center;min-height:100vh;padding:16px}
  .box{width:100%;max-width:1200px;padding:24px;border-radius:16px;background:var(--card);box-shadow:0 6px 30px rgba(0,0,0,0.4);min-height:auto}
  h1,h2{margin:8px 0 12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px}
  .icon{background:var(--card-2);padding:18px;border-radius:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:700}
  .icon:hover{transform:scale(1.03);transition:.15s}
  input,select,textarea{width:96%;padding:10px;margin:8px 0;border-radius:8px;border:none;outline:none}
  textarea{min-height:60px}
  button{background:#00cc99;border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700;margin-right:8px}
  button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.12)}
  .hidden{display:none !important}
  .topbar{display:flex;justify-content:space-between;align-items:center}
  table{width:100%;border-collapse:collapse;margin-top:12px;color:#fff}
  th,td{padding:8px;border:1px solid rgba(255,255,255,0.12);text-align:center}
  th{background:rgba(0,0,0,0.25)}
  .actions button{margin:4px}
  .small{font-size:0.9rem;padding:6px 10px}
  .danger{background:#ff6b6b}
  .note{font-size:0.9rem;color:#e5f7ef}
  .flexrow{display:flex;gap:8px;align-items:center}
  .center{display:flex;justify-content:center;align-items:center}
  .readonly{background:rgba(255,255,255,0.03);opacity:0.95}
  .notif{background:rgba(255,255,255,0.06);padding:10px;border-radius:8px;margin:8px 0}
  .report-section{margin-bottom:20px;padding:15px;border-radius:10px;background:rgba(255,255,255,0.05)}
  .report-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .report-stats{display:flex;gap:15px;margin-bottom:15px}
  .stat-card{background:rgba(255,255,255,0.08);padding:10px;border-radius:8px;flex:1;text-align:center}
  .back-btn{background:#4a6fa5;margin-bottom:15px}
  .user-management-container {display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap;}
  .user-form-container {flex: 1; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; min-width: 300px;}
  .user-list-container {flex: 2; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; min-width: 500px;}
  .form-group {margin-bottom: 15px;}
  .form-group label {display: block; margin-bottom: 5px; font-weight: bold;}
  .form-actions {display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;}
  .user-type-badge {padding: 3px 8px; border-radius: 12px; font-size: 0.8rem;}
  .user-type-admin {background: #ff6b6b; color: white;}
  .user-type-user {background: #00cc99; color: white;}
  .message-success {background: rgba(0, 204, 153, 0.2); color: #00cc99; border: 1px solid #00cc99;}
  .message-error {background: rgba(255, 107, 107, 0.2); color: #ff6b6b; border: 1px solid #ff6b6b;}
  .message-info {background: rgba(255, 255, 255, 0.1); color: #ffffff; border: 1px solid rgba(255, 255, 255, 0.2);}
  .modal {position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000;}
  .modal-content {background: var(--card); padding: 20px; border-radius: 10px; width: 90%; max-width: 500px;}
  .modal-header {display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;}
  .close-btn {background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer;}
  .quantity-history {margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;}
  .history-item {display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);}
  .history-item:last-child {border-bottom: none;}

  .section {
    max-height: none;
    overflow: visible;
  }
  
  .section-content {
    max-height: none;
    overflow-y: visible;
  }
  
  .form-container {
    background: rgba(255,255,255,0.05);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    position: sticky;
    top: 0;
    z-index: 5;
  }
  
  .table-container {
    max-height: 60vh;
    overflow-y: auto;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    margin-top: 10px;
  }
  
  .table-container table {
    margin-top: 0;
  }
  
  .table-container thead th {
    position: sticky;
    top: 0;
    background: rgba(0,0,0,0.4);
    z-index: 2;
  }

  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .machine-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px;
    margin: 5px 0;
    background: rgba(255,255,255,0.05);
    border-radius: 5px;
  }

  .invoice-status-pending { color: #ffa500; }
  .invoice-status-approved { color: #00cc99; }
  .invoice-status-rejected { color: #ff6b6b; }

  .branch-report-details {
    background: rgba(255,255,255,0.05);
    padding: 15px;
    border-radius: 8px;
    margin: 10px 0;
  }

  .report-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .report-tab {
    padding: 10px 20px;
    background: rgba(255,255,255,0.1);
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s;
  }
  
  .report-tab.active {
    background: #00cc99;
  }
  
  .report-tab:hover {
    background: rgba(255,255,255,0.2);
  }

  /* ØªØµÙ…ÙŠÙ… Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */
  .user-dashboard {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
  }
  
  .dashboard-card {
    background: rgba(255,255,255,0.08);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  
  .dashboard-card h3 {
    margin-top: 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    padding-bottom: 10px;
  }

  /* ØªØµÙ…ÙŠÙ… Ø¨Ø·Ø§Ù‚Ø§Øª Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± */
  .parts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 15px;
    margin-top: 15px;
  }
  
  .part-card {
    background: rgba(255,255,255,0.08);
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: transform 0.2s;
  }
  
  .part-card:hover {
    transform: translateY(-5px);
    background: rgba(255,255,255,0.12);
  }
  
  .part-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .part-card-header strong {
    color: #00cc99;
    font-size: 1.1rem;
  }
  
  .part-code {
    background: rgba(255,255,255,0.1);
    padding: 3px 8px;
    border-radius: 5px;
    font-size: 0.8rem;
    font-family: monospace;
  }
  
  .part-quantity {
    font-size: 1.2rem;
    font-weight: bold;
    margin: 8px 0;
  }
  
  .quantity-status {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: bold;
    display: inline-block;
  }
  
  .status-available {
    background: rgba(0, 204, 153, 0.2);
    color: #00cc99;
    border: 1px solid #00cc99;
  }
  
  .status-low {
    background: rgba(255, 165, 0, 0.2);
    color: #ffa500;
    border: 1px solid #ffa500;
  }
  
  .status-unavailable {
    background: rgba(255, 107, 107, 0.2);
    color: #ff6b6b;
    border: 1px solid #ff6b6b;
  }
  
  .search-box {
    margin-bottom: 20px;
  }
  
  .search-box input {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.1);
    color: white;
    font-size: 1rem;
  }
  
  .search-box input::placeholder {
    color: rgba(255,255,255,0.6);
  }

  /* ØªØµÙ…ÙŠÙ… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù‚Ø·Ø¹ */
  .multi-invoice-form {
    background: rgba(255,255,255,0.05);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
  }
  
  .invoice-items-table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0;
  }
  
  .invoice-items-table th {
    background: rgba(0,0,0,0.3);
    padding: 10px;
    text-align: center;
  }
  
  .invoice-items-table td {
    padding: 8px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  
  .invoice-summary {
    background: rgba(255,255,255,0.08);
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
  }
  
  .item-actions {
    display: flex;
    gap: 5px;
    justify-content: center;
  }
  
  @media (max-width: 768px) {
    .user-dashboard {
      grid-template-columns: 1fr;
    }
  }

  /* Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… */
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  
  .section-header h4 {
    margin: 0;
    color: #00cc99;
  }
  
  .status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: bold;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  
  .status-success {
    background: rgba(0, 204, 153, 0.2);
    color: #00cc99;
    border: 1px solid #00cc99;
  }
  
  .status-warning {
    background: rgba(255, 165, 0, 0.2);
    color: #ffa500;
    border: 1px solid #ffa500;
  }
  
  .status-danger {
    background: rgba(255, 107, 107, 0.2);
    color: #ff6b6b;
    border: 1px solid #ff6b6b;
  }
  
  .status-info {
    background: rgba(74, 111, 165, 0.2);
    color: #4a6fa5;
    border: 1px solid #4a6fa5;
  }
  
  .badge {
    background: rgba(255,255,255,0.1);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.8rem;
    font-weight: bold;
  }
  
  .stat-mini-card {
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    color: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  
  .stat-mini-card div:first-child {
    font-size: 0.9rem;
    opacity: 0.9;
    margin-bottom: 8px;
  }
  
  button.active {
    background: #00cc99 !important;
    transform: scale(1.05);
  }
  
  code {
    background: rgba(255,255,255,0.1);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: monospace;
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="box" id="app">

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div id="loadingView" class="center" style="flex-direction: column; gap: 20px;">
      <div class="loading"></div>
      <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</p>
    </div>

    <!-- LOGIN -->
    <div id="loginView" class="hidden">
      <h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ù…Ù†Ø¸ÙˆÙ…Ø© Ø¢Ù„Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø°Ø§ØªÙŠ</h1>
      <div style="max-width:480px;margin:0 auto">
        <input id="loginName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />
        <input id="loginPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" type="password" />
        <div class="flexrow" style="justify-content:center;margin-top:8px">
          <button onclick="doLogin()">Ø¯Ø®ÙˆÙ„</button>
        </div>
        <p id="loginError" style="color:#ffb3b3;text-align:center;font-weight:700"></p>
        <p class="note center">ØµÙ…Ù…Øª Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ / Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­ÙŠÙ… ØºÙŠØ« Ø§Ù„Ø·Ø§Ù‡Ø±</p>
      </div>
    </div>

    <!-- MAIN - Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ -->
    <div id="mainView" class="hidden">
      <div class="topbar">
        <div>
          <h2>Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
          <div class="note" id="currentUserNote"></div>
        </div>
        <div class="flexrow">
          <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>

      <div style="margin-top:12px" id="menuGrid" class="grid"></div>
      <div id="sectionsContainer" style="margin-top:18px"></div>
    </div>

    <!-- USER DASHBOARD - Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ -->
    <div id="userDashboard" class="hidden">
      <div class="topbar">
        <div>
          <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - Ù…Ù†Ø¸ÙˆÙ…Ø© Ø¢Ù„Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø°Ø§ØªÙŠ</h2>
          <div class="note" id="currentUserNoteDashboard"></div>
        </div>
        <div class="flexrow">
          <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>

      <div class="user-dashboard">
        <div class="dashboard-card">
          <h3>ğŸ“ƒ Ø·Ù„Ø¨ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
          <div id="userInvoiceForm">
            <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø·Ø¹ -->
            <div class="multi-invoice-form">
              <h4>Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</h4>
              <div class="form-group">
                <label>ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø·Ø¹Ø©:</label>
                <input id="userInvPartCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø·Ø¹Ø©" oninput="userInvAutoFill()" />
              </div>
              <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©:</label>
                <input id="userInvPartName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø© (ÙŠØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)" readonly />
              </div>
              <div class="form-group">
                <label>Ø§Ù„ÙƒÙ…ÙŠØ©:</label>
                <input id="userInvQty" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" min="1" />
              </div>
              <div class="form-group">
                <label>Ø¢Ù„Ø© Ø§Ù„Ø³Ø­Ø¨:</label>
                <select id="userInvMachine">
                  <option value="">Ø§Ø®ØªØ± Ø¢Ù„Ø© Ø§Ù„Ø³Ø­Ø¨</option>
                </select>
              </div>
              <div class="form-group">
                <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨:</label>
                <input id="userInvDate" placeholder="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨" readonly />
              </div>
              <div class="form-actions">
                <button onclick="addItemToInvoice()">â• Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø©</button>
              </div>
            </div>

            <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ù…Ø¶Ø§ÙØ© -->
            <div class="table-container">
              <table class="invoice-items-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø·Ø¹Ø©</th>
                    <th>Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th>Ø¢Ù„Ø© Ø§Ù„Ø³Ø­Ø¨</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                  </tr>
                </thead>
                <tbody id="invoiceItemsTable">
                  <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                </tbody>
              </table>
            </div>

            <!-- Ù…Ù„Ø®Øµ Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
            <div class="invoice-summary">
              <div class="flexrow" style="justify-content: space-between; align-items: center;">
                <div>
                  <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø·Ø¹: <span id="totalItemsCount">0</span></strong>
                </div>
                <div>
                  <button onclick="clearInvoiceItems()" class="secondary small">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
                  <button onclick="userSendInvoice()" style="margin-left: 10px;">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Ù‚Ø³Ù… Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
        <div class="dashboard-card">
          <h3>ğŸ”§ Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©</h3>
          <div class="search-box">
            <input type="text" id="userPartsSearch" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø·Ø¹Ø© ØºÙŠØ§Ø± Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯..." oninput="filterUserParts()" />
          </div>
          <div id="userPartsContainer" style="max-height: 300px; overflow-y: auto;">
            <div class="notif">
              <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±...</p>
            </div>
          </div>
          <div style="margin-top: 10px; text-align: center;">
            <button class="small" onclick="openUserPartsView()">ğŸ“‹ Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø¹</button>
          </div>
        </div>

        <div class="dashboard-card" style="grid-column: span 2;">
          <h3>ğŸ“‹ Ø³Ø¬Ù„ ÙÙˆØ§ØªÙŠØ±ÙŠ</h3>
          <div class="table-container">
            <table id="userInvoicesTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                  <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹</th>
                  <th>Ø¢Ù„Ø© Ø§Ù„Ø³Ø­Ø¨</th>
                  <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th>ØªÙØ§ØµÙŠÙ„</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ -->
    <!-- BANKS SECTION -->
    <div id="banksSection" class="hidden section">
      <h2>ğŸ¦ ÙØ±ÙˆØ¹ Ø§Ù„Ù…ØµØ§Ø±Ù</h2>
      <div class="form-container">
        <div class="flexrow" style="flex-wrap:wrap">
          <input id="bankNameIn" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±Ù" />
          <input id="bankKeyIn" placeholder="Ù…ÙØªØ§Ø­ Ø§Ù„Ù…ØµØ±Ù" />
          <button onclick="addBank()">â• Ø¥Ø¶Ø§ÙØ©</button>
        </div>
      </div>
      <div class="table-container">
        <table id="banksTable">
          <thead><tr><th>Ø§Ù„Ø±Ù‚Ù…</th><th>Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±Ù</th><th>Ø§Ù„Ù…ÙØªØ§Ø­</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- MACHINES SECTION -->
    <div id="machinesSection" class="hidden section">
      <h2>ğŸ–¥ï¸ Ø¢Ù„Ø§Øª Ø§Ù„Ø³Ø­Ø¨</h2>
      <div class="form-container">
        <div class="flexrow" style="flex-wrap:wrap">
          <input id="machineNumberIn" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¢Ù„Ø©" />
          <select id="machineBranchIn"><option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹</option></select>
          <button onclick="addMachine()">â• Ø¥Ø¶Ø§ÙØ©</button>
        </div>
      </div>
      <div class="table-container">
        <table id="machinesTable">
          <thead><tr><th>#</th><th>Ø±Ù‚Ù… Ø§Ù„Ø¢Ù„Ø©</th><th>Ø§Ù„ÙØ±Ø¹</th><th>Ù…ÙØªØ§Ø­ Ø§Ù„Ù…ØµØ±Ù</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- USERS SECTION -->
    <div id="usersSection" class="hidden section">
      <h2>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
      <div class="user-management-container">
        <div class="user-form-container">
          <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h3>
          <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
            <input id="userNameIn" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />
          </div>
          <div class="form-group">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
            <input id="userPassIn" type="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
          </div>
          <div class="form-group">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
            <select id="userTypeIn">
              <option value="user">Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ</option>
              <option value="admin">Ù…Ø³Ø¤ÙˆÙ„ Ù†Ø¸Ø§Ù…</option>
            </select>
          </div>
          <div class="form-group" id="branchField">
            <label>Ø§Ù„ÙØ±Ø¹ Ø§Ù„ØªØ§Ø¨Ø¹ Ù„Ù‡:</label>
            <select id="userBranchIn">
              <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹</option>
            </select>
          </div>
          <div class="form-actions">
            <button onclick="addUser()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
          </div>
        </div>
        
        <div class="user-list-container">
          <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
          <div class="table-container">
            <table id="usersTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                  <th>Ø§Ù„ÙØ±Ø¹</th>
                  <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                  <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©</th>
                  <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- PARTS SECTION -->
    <div id="partsSection" class="hidden section">
      <h2>ğŸ”§ Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±</h2>
      <div class="form-container">
        <h3>Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹Ø© ØºÙŠØ§Ø± Ø¬Ø¯ÙŠØ¯Ø©</h3>
        <div class="flexrow" style="flex-wrap: wrap; gap: 10px;">
          <input id="partCodeIn" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø·Ø¹Ø©" />
          <input id="partNameIn" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©" />
          <input id="partQuantityIn" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø®Ø²Ù†Ø©" min="0" />
          <div class="form-actions">
            <button onclick="addPart()">â• Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹Ø©</button>
          </div>
        </div>
      </div>
      
      <div class="table-container">
        <table id="partsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø·Ø¹Ø©</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</th>
              <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø®Ø²Ù†Ø©</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- INVOICES SECTION -->
    <div id="invoicesSection" class="hidden section">
      <h2>ğŸ“ƒ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠØ©</h2>

      <!-- For user: show parts list and invoice form -->
      <div id="invoiceArea">
        <div class="form-container">
          <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end">
            <div style="flex:1;min-width:260px">
              <h4>Ù‚Ø§Ø¦Ù…Ø© Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©</h4>
              <div class="table-container" style="max-height: 200px;">
                <table id="partsListTable">
                  <thead><tr><th>ÙƒÙˆØ¯</th><th>Ø§Ù„Ø§Ø³Ù…</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div style="flex:1;min-width:260px">
              <h4>Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h4>
              <input id="invPartCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø·Ø¹Ø©" oninput="invAutoFill()" />
              <input id="invPartName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø© (ÙŠØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)" readonly />
              <input id="invQty" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" min="1" />
              <input id="invDate" placeholder="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨" readonly />
              <select id="invMachine">
                <option value="">Ø§Ø®ØªØ± Ø¢Ù„Ø© Ø§Ù„Ø³Ø­Ø¨</option>
              </select>
              <button onclick="sendInvoice()">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
            </div>
          </div>
        </div>

        <h4 style="margin-top:12px">Ø³Ø¬Ù„ ÙÙˆØ§ØªÙŠØ±ÙŠ</h4>
        <div class="table-container">
          <table id="myInvoicesTable">
            <thead><tr><th>#</th><th>ÙƒÙˆØ¯</th><th>Ø§Ø³Ù…</th><th>ÙƒÙ…ÙŠØ©</th><th>Ø¢Ù„Ø© Ø§Ù„Ø³Ø­Ø¨</th><th>ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- For admin: list of all invoices with actions -->
      <div id="adminInvoiceArea" class="hidden">
        <h4>Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ø±Ø¯Ø© ØªØ­ØªØ§Ø¬ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h4>
        <div id="adminInvoicesList"></div>

        <h4 style="margin-top:12px">Ø³Ø¬Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h4>
        <div class="table-container">
          <table id="adminSavedInvoices">
            <thead><tr><th>#</th><th>Ù…Ù‚Ø¯Ù… Ø§Ù„Ø·Ù„Ø¨</th><th>ÙƒÙˆØ¯</th><th>Ø§Ø³Ù…</th><th>ÙƒÙ…ÙŠØ©</th><th>Ø¢Ù„Ø© Ø§Ù„Ø³Ø­Ø¨</th><th>ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- NOTIFICATIONS SECTION -->
    <div id="notificationsSection" class="hidden section">
      <h2>ğŸ”” Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h2>
      <div class="table-container">
        <div id="notificationsContainer"></div>
      </div>
    </div>

    <!-- REPORTS SECTION -->
    <div id="reportsSection" class="hidden section">
      <button class="back-btn" onclick="backToMain()">â¬… Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <h2>ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
      
      <div class="report-tabs">
        <div class="report-tab active" onclick="showReportTab('partsReport')">ğŸ“¦ ØªÙ‚Ø±ÙŠØ± Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±</div>
        <div class="report-tab" onclick="showReportTab('branchesReport')">ğŸ¦ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙØ±ÙˆØ¹</div>
      </div>

      <!-- ØªÙ‚Ø§Ø±ÙŠØ± Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± -->
      <div id="partsReport" class="report-section">
        <div class="report-header">
          <h3>ğŸ“¦ ØªÙ‚Ø±ÙŠØ± Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±</h3>
          <button onclick="printPartsReport()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>
        
        <div class="report-stats">
          <div class="stat-card">
            <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø·Ø¹</div>
            <div id="totalPartsCount" style="font-size:1.5rem;font-weight:bold">0</div>
          </div>
          <div class="stat-card">
            <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©</div>
            <div id="totalPartsQuantity" style="font-size:1.5rem;font-weight:bold">0</div>
          </div>
          <div class="stat-card">
            <div>Ù…ØªÙˆØ³Ø· Ø§Ù„ÙƒÙ…ÙŠØ©</div>
            <div id="avgPartsQuantity" style="font-size:1.5rem;font-weight:bold">0</div>
          </div>
        </div>
        
        <div class="table-container">
          <table id="partsReportTable">
            <thead>
              <tr>
                <th>#</th>
                <th>ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø·Ø¹Ø©</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</th>
                <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th>
                <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨</th>
                <th>Ø¢Ø®Ø± Ø­Ø±ÙƒØ©</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      
      <!-- ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙØ±ÙˆØ¹ -->
      <div id="branchesReport" class="report-section hidden">
        <div class="report-header">
          <h3>ğŸ¦ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙØ±ÙˆØ¹</h3>
          <button onclick="printBranchesReport()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>
        
        <div class="report-stats">
          <div class="stat-card">
            <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ±ÙˆØ¹</div>
            <div id="totalBranchesCount" style="font-size:1.5rem;font-weight:bold">0</div>
          </div>
          <div class="stat-card">
            <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</div>
            <div id="totalInvoicesCount" style="font-size:1.5rem;font-weight:bold">0</div>
          </div>
          <div class="stat-card">
            <div>Ù…ØªÙˆØ³Ø· Ø§Ù„ÙÙˆØ§ØªÙŠØ±/ÙØ±Ø¹</div>
            <div id="avgInvoicesPerBranch" style="font-size:1.5rem;font-weight:bold">0</div>
          </div>
        </div>
        
        <div class="table-container">
          <div id="branchesReportContainer"></div>
        </div>

        <!-- ØªÙØ§ØµÙŠÙ„ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙØ±ÙˆØ¹ -->
        <div id="branchDetailsContainer" style="margin-top: 20px;"></div>
      </div>
    </div>

  </div>
</div>

<script>
// ==================== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ====================
let currentUser = null;
let editingUserId = null;
let selectedPartForQuantity = null;
let allUserParts = [];
let invoiceItems = []; // Ù…ØµÙÙˆÙØ© Ù„ØªØ®Ø²ÙŠÙ† Ù‚Ø·Ø¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©

// DOM Elements
const loginView = document.getElementById('loginView');
const mainView = document.getElementById('mainView');
const userDashboard = document.getElementById('userDashboard');
const menuGrid = document.getElementById('menuGrid');
const loginError = document.getElementById('loginError');

// ==================== Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù‚Ø·Ø¹ ====================

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
function addItemToInvoice() {
    const partCode = document.getElementById('userInvPartCode').value.trim();
    const partName = document.getElementById('userInvPartName').value.trim();
    const quantity = parseInt(document.getElementById('userInvQty').value) || 0;
    const machineId = document.getElementById('userInvMachine').value;
    const date = document.getElementById('userInvDate').value;
    
    if (!partCode || !partName || quantity <= 0 || !machineId) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
        return;
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø¢Ù„Ø©
    const machineSelect = document.getElementById('userInvMachine');
    const machineName = machineSelect.options[machineSelect.selectedIndex].text;
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø·Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµÙÙˆÙØ©
    const newItem = {
        id: Date.now(), // Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ù‚Ø·Ø¹Ø©
        part_code: partCode,
        part_name: partName,
        quantity: quantity,
        machine_id: machineId,
        machine_name: machineName,
        date: date
    };
    
    invoiceItems.push(newItem);
    
    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    updateInvoiceItemsTable();
    
    // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
    document.getElementById('userInvPartCode').value = '';
    document.getElementById('userInvPartName').value = '';
    document.getElementById('userInvQty').value = '';
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ù…Ø¶Ø§ÙØ©
function updateInvoiceItemsTable() {
    const tbody = document.getElementById('invoiceItemsTable');
    const totalItemsElement = document.getElementById('totalItemsCount');
    
    tbody.innerHTML = '';
    
    if (invoiceItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø·Ø¹ Ù…Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø©</td></tr>';
        totalItemsElement.textContent = '0';
        return;
    }
    
    invoiceItems.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${index + 1}</td>
            <td>${item.part_code}</td>
            <td>${item.part_name}</td>
            <td>${item.quantity}</td>
            <td>${item.machine_name}</td>
            <td class="item-actions">
                <button class="small danger" onclick="removeInvoiceItem(${item.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    
    totalItemsElement.textContent = invoiceItems.length;
}

// Ø¯Ø§Ù„Ø© Ù„Ø­Ø°Ù Ù‚Ø·Ø¹Ø© Ù…Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø©
function removeInvoiceItem(itemId) {
    invoiceItems = invoiceItems.filter(item => item.id !== itemId);
    updateInvoiceItemsTable();
}

// Ø¯Ø§Ù„Ø© Ù„Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø¹ Ù…Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø©
function clearInvoiceItems() {
    if (invoiceItems.length === 0) {
        return;
    }
    
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø¹ Ù…Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ')) {
        invoiceItems = [];
        updateInvoiceItemsTable();
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø¹Ø¯Ù„Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø¹ Ø¹Ø¯Ø© Ù‚Ø·Ø¹
async function userSendInvoice() {
    if (invoiceItems.length === 0) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„ÙØ§ØªÙˆØ±Ø©');
        return;
    }

    try {
        showLoading(true);
        
        // Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ„ Ù‚Ø·Ø¹Ø© ÙƒÙØ§ØªÙˆØ±Ø© Ù…Ù†ÙØµÙ„Ø©
        const promises = invoiceItems.map(item => 
            apiCall('invoices.php', 'POST', {
                part_code: item.part_code,
                part_name: item.part_name,
                quantity: item.quantity,
                date: item.date,
                machine_id: item.machine_id,
                user_id: currentUser.id,
                status: 'pending'
            })
        );
        
        await Promise.all(promises);
        
        // Ù…Ø³Ø­ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø§Ø¬Ø­
        invoiceItems = [];
        updateInvoiceItemsTable();
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
        await loadUserInvoices();
        alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// ==================== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ====================
async function initializeSystem() {
    try {
        showLoading(true);
        
        // ÙØ­Øµ Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const installCheck = await fetch('install.php');
        const installResult = await installCheck.json();
        
        if (!installResult.success) {
            throw new Error('ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }
        
        console.log('âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…');
        showLoading(false);
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…:', error);
        showLoading(false);
        
        const errorDiv = document.createElement('div');
        errorDiv.style.background = 'rgba(255,0,0,0.1)';
        errorDiv.style.padding = '15px';
        errorDiv.style.borderRadius = '8px';
        errorDiv.style.margin = '15px 0';
        errorDiv.style.border = '1px solid red';
        errorDiv.innerHTML = `
            <h3>âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
            <p>${error.message}</p>
            <p><strong>Ø­Ù„ÙˆÙ„ Ù…Ù‚ØªØ±Ø­Ø©:</strong></p>
            <ul>
                <li>ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø®Ø§Ø¯Ù… Ø§Ù„ÙˆÙŠØ¨ (XAMPP, WAMP)</li>
                <li>ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ MySQL</li>
                <li>Ø§ÙØªØ­ <a href="install.php" target="_blank">install.php</a> Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</li>
            </ul>
            <button onclick="location.reload()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„</button>
        `;
        
        loginView.appendChild(errorDiv);
    }
}

// ==================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… ====================
const API_BASE = './';

async function apiCall(endpoint, method = 'GET', data = null) {
    try {
        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            }
        };

        if (data && (method === 'POST' || method === 'PUT' || method === 'DELETE')) {
            options.body = JSON.stringify(data);
        }

        const response = await fetch(API_BASE + endpoint, options);
        
        if (!response.ok) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            return result.data;
        } else {
            throw new Error(result.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ');
        }
    } catch (error) {
        console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ ${endpoint}:`, error);
        throw error;
    }
}

// ==================== Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ====================
async function doLogin() {
    const username = document.getElementById('loginName').value.trim();
    const password = document.getElementById('loginPass').value.trim();
    
    if (!username || !password) {
        showLoginError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
        return;
    }

    try {
        showLoading(true);
        
        const response = await fetch('login.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                username: username, 
                password: password 
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentUser = result.data;
            loginView.classList.add('hidden');
            
            // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if (currentUser.user_type === 'admin') {
                mainView.classList.remove('hidden');
                buildMenu();
            } else {
                userDashboard.classList.remove('hidden');
                await initializeUserDashboard();
            }
            
            showHomeNote();
        } else {
            showLoginError(result.message || 'âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
        showLoginError('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø®Ø§Ø¯Ù… Ø§Ù„ÙˆÙŠØ¨');
    } finally {
        showLoading(false);
    }
}

function showLoginError(message) {
    document.getElementById('loginError').textContent = message;
}

function clearLoginError() {
    document.getElementById('loginError').textContent = '';
}

function logout() { 
    currentUser = null; 
    hideAllSections();
    mainView.classList.add('hidden'); 
    userDashboard.classList.add('hidden');
    loginView.classList.remove('hidden'); 
    document.getElementById('loginName').value = ''; 
    document.getElementById('loginPass').value = ''; 
}

// ==================== Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ====================
function buildMenu() {
    let menuItems = [];
    
    if (currentUser.user_type === 'admin') {
        // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„
        menuItems = [
            { icon: 'ğŸ¦', text: 'ÙØ±ÙˆØ¹ Ø§Ù„Ù…ØµØ§Ø±Ù', onClick: 'openBanks()' },
            { icon: 'ğŸ–¥ï¸', text: 'Ø¢Ù„Ø§Øª Ø§Ù„Ø³Ø­Ø¨', onClick: 'openMachines()' },
            { icon: 'ğŸ”§', text: 'Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±', onClick: 'openParts()' },
            { icon: 'ğŸ‘¥', text: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', onClick: 'openUsers()' },
            { icon: 'ğŸ“ƒ', text: 'Ø§Ù„ÙÙˆØ§ØªÙŠØ±', onClick: 'openInvoices()' },
            { icon: 'ğŸ“Š', text: 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±', onClick: 'openReports()' },
            { icon: 'ğŸ””', text: 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', onClick: 'openNotifications()' }
        ];
    } else {
        // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ
        menuItems = [
            { icon: 'ğŸ“ƒ', text: 'Ø·Ù„Ø¨ ÙØ§ØªÙˆØ±Ø©', onClick: 'openInvoices()' },
            { icon: 'ğŸ”§', text: 'Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±', onClick: 'openParts()' }
        ];
    }

    menuGrid.innerHTML = '';
    
    menuItems.forEach(item => {
        const div = document.createElement('div');
        div.className = 'icon';
        div.innerHTML = `${item.icon}<br>${item.text}`;
        div.onclick = () => eval(item.onClick);
        menuGrid.appendChild(div);
    });
}

function showHomeNote() {
    const note = document.getElementById('currentUserNote');
    if (note) {
        note.textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.username} - ${currentUser.user_type === 'admin' ? 'Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…' : 'Ù…Ø³ØªØ®Ø¯Ù…'}`;
    }
    
    const dashboardNote = document.getElementById('currentUserNoteDashboard');
    if (dashboardNote) {
        dashboardNote.textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.username} - ${currentUser.branch_name || 'Ù…Ø³ØªØ®Ø¯Ù…'}`;
    }
}

// ==================== ØªÙ‡ÙŠØ¦Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ ====================
async function initializeUserDashboard() {
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ
    document.getElementById('userInvDate').value = new Date().toISOString().split('T')[0];
    
    // ØªØ­Ù…ÙŠÙ„ Ø¢Ù„Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„ÙØ±Ø¹
    await fillUserMachineSelect();
    
    // ØªØ­Ù…ÙŠÙ„ Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±
    await loadUserParts();
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
    await loadUserInvoices();
    
    // ØªÙ‡ÙŠØ¦Ø© Ù…ØµÙÙˆÙØ© Ù‚Ø·Ø¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
    invoiceItems = [];
    updateInvoiceItemsTable();
}

// ==================== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ ====================
async function fillUserMachineSelect() {
    const select = document.getElementById('userInvMachine');
    select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¢Ù„Ø© Ø§Ù„Ø³Ø­Ø¨</option>';
    
    try {
        const allMachines = await apiCall('machines.php');
        const userMachines = allMachines.filter(machine => machine.branch_id == currentUser.branch_id);
        
        userMachines.forEach(machine => {
            const option = document.createElement('option');
            option.value = machine.id;
            option.textContent = `${machine.machine_number} - ${machine.branch_name}`;
            select.appendChild(option);
        });
        
        if (userMachines.length === 0) {
            select.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¢Ù„Ø§Øª Ø³Ø­Ø¨ Ù…ØªØ§Ø­Ø© Ù„ÙØ±Ø¹Ùƒ</option>';
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¢Ù„Ø§Øª Ø§Ù„Ø³Ø­Ø¨:', error);
    }
}

async function userInvAutoFill() {
    const code = document.getElementById('userInvPartCode').value.trim();
    const nameInput = document.getElementById('userInvPartName');
    
    if (!code) {
        nameInput.value = '';
        return;
    }
    
    try {
        const parts = await apiCall('parts.php');
        const part = parts.find(p => p.code === code);
        
        if (part) {
            nameInput.value = part.name;
        } else {
            nameInput.value = '';
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù‚Ø·Ø¹Ø©:', error);
    }
}

// ==================== Ø¯ÙˆØ§Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ ====================
async function loadUserInvoices() {
    const tbody = document.querySelector('#userInvoicesTable tbody'); 
    tbody.innerHTML = ''; 
    
    try {
        const invoices = await apiCall('invoices.php');
        const userInvoices = invoices.filter(inv => inv.user_id == currentUser.id);
        
        if (userInvoices.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø¶Ø§ÙØ© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td></tr>`;
            return;
        }
        
        // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø¢Ù„Ø©
        const groupedInvoices = groupInvoicesByDateAndMachine(userInvoices);
        
        groupedInvoices.forEach((group, index) => { 
            const tr = document.createElement('tr'); 
            const statusClass = `invoice-status-${group.status}`;
            
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td>ÙØ§ØªÙˆØ±Ø© #${group.id}</td>
                <td>${group.itemsCount} Ù‚Ø·Ø¹</td>
                <td>${group.machine_name}</td>
                <td>${group.date}</td>
                <td class="${statusClass}">
                    ${group.status === 'pending' ? 'â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' : 
                      group.status === 'approved' ? 'âœ… Ù…Ø¹ØªÙ…Ø¯Ø©' : 'âŒ Ù…Ø±ÙÙˆØ¶Ø©'}
                </td>
                <td>
                    <button class="small" onclick="showInvoiceDetails(${group.id})">ğŸ“‹ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
                </td>
            `; 
            tbody.appendChild(tr); 
        });
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:', error);
    }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø¢Ù„Ø©
function groupInvoicesByDateAndMachine(invoices) {
    const groups = {};
    
    invoices.forEach(invoice => {
        const key = `${invoice.date}_${invoice.machine_id}`;
        
        if (!groups[key]) {
            groups[key] = {
                id: invoice.id,
                date: invoice.date,
                machine_id: invoice.machine_id,
                machine_name: invoice.machine_number,
                status: invoice.status,
                itemsCount: 0,
                items: []
            };
        }
        
        groups[key].itemsCount++;
        groups[key].items.push(invoice);
    });
    
    return Object.values(groups);
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
function showInvoiceDetails(invoiceId) {
    // ØªÙ†ÙÙŠØ° Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙÙŠ Ù…ÙˆØ¯Ø§Ù„ Ø£Ùˆ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø©
    alert('ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒØ§Ù…Ù„');
}

// ==================== Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ ====================
async function loadUserParts() {
    const container = document.getElementById('userPartsContainer');
    
    try {
        const parts = await apiCall('parts.php');
        allUserParts = parts;
        
        if (parts.length === 0) {
            container.innerHTML = '<div class="notif">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø·Ø¹ ØºÙŠØ§Ø± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
            return;
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø·Ø¹ Ù…Ø¹ Ø§Ù„ØªØµÙÙŠØ© (Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 5 Ù‚Ø·Ø¹ ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)
        displayUserParts(parts.slice(0, 5));
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±:', error);
        container.innerHTML = '<div class="notif">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±</div>';
    }
}

function displayUserParts(parts) {
    const container = document.getElementById('userPartsContainer');
    container.innerHTML = '';
    
    if (parts.length === 0) {
        container.innerHTML = '<div class="notif">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø·Ø¹ ØºÙŠØ§Ø± ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø«</div>';
        return;
    }
    
    parts.forEach(part => {
        const quantity = parseInt(part.quantity) || 0;
        const status = getQuantityStatus(quantity);
        
        const partCard = document.createElement('div');
        partCard.className = 'part-card';
        partCard.innerHTML = `
            <div class="part-card-header">
                <strong>${part.name}</strong>
                <span class="part-code">${part.code}</span>
            </div>
            <div class="part-quantity">${quantity} Ù‚Ø·Ø¹Ø©</div>
            <div class="quantity-status ${status.class}">${status.text}</div>
            <div style="margin-top: 10px; font-size: 0.8rem; color: #ccc;">
                ${part.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}
            </div>
        `;
        container.appendChild(partCard);
    });
}

function getQuantityStatus(quantity) {
    if (quantity > 10) {
        return { class: 'status-available', text: 'Ù…ØªØ§Ø­Ø©' };
    } else if (quantity > 0) {
        return { class: 'status-low', text: 'Ù…Ù†Ø®ÙØ¶Ø©' };
    } else {
        return { class: 'status-unavailable', text: 'ØºÙŠØ± Ù…ØªØ§Ø­Ø©' };
    }
}

function filterUserParts() {
    const searchTerm = document.getElementById('userPartsSearch').value.toLowerCase().trim();
    
    if (!searchTerm) {
        // Ø¥Ø±Ø¬Ø§Ø¹ Ø£ÙˆÙ„ 5 Ù‚Ø·Ø¹ ÙÙ‚Ø· Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        displayUserParts(allUserParts.slice(0, 5));
        return;
    }
    
    const filteredParts = allUserParts.filter(part => 
        part.name.toLowerCase().includes(searchTerm) || 
        part.code.toLowerCase().includes(searchTerm) ||
        (part.description && part.description.toLowerCase().includes(searchTerm))
    );
    
    // Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
    displayUserParts(filteredParts);
}

// ==================== Ø´Ø§Ø´Ø© Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ ====================
async function openUserPartsView() {
    hideAllSections();
    
    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø±Ø¶ Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ
    const sectionsContainer = document.getElementById('sectionsContainer');
    sectionsContainer.innerHTML = `
        <div class="section">
            <div class="topbar">
                <h2>ğŸ”§ Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
                <button class="back-btn" onclick="backToUserDashboard()">â¬… Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
            </div>
            
            <div class="search-box">
                <input type="text" id="userPartsSearchFull" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ø·Ø¹Ø© ØºÙŠØ§Ø± Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯..." oninput="filterUserPartsFull()" />
            </div>
            
            <div class="report-stats">
                <div class="stat-card">
                    <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø·Ø¹</div>
                    <div id="userTotalParts" style="font-size:1.5rem;font-weight:bold">0</div>
                </div>
                <div class="stat-card">
                    <div>Ø§Ù„Ù…ØªØ§Ø­Ø©</div>
                    <div id="userAvailableParts" style="font-size:1.5rem;font-weight:bold;color:#00cc99">0</div>
                </div>
                <div class="stat-card">
                    <div>Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„ÙƒÙ…ÙŠØ©</div>
                    <div id="userLowParts" style="font-size:1.5rem;font-weight:bold;color:#ffa500">0</div>
                </div>
                <div class="stat-card">
                    <div>ØºÙŠØ± Ù…ØªØ§Ø­Ø©</div>
                    <div id="userUnavailableParts" style="font-size:1.5rem;font-weight:bold;color:#ff6b6b">0</div>
                </div>
            </div>
            
            <div id="userPartsViewContainer" class="parts-grid"></div>
        </div>
    `;
    
    await loadUserPartsView();
}

async function loadUserPartsView() {
    const container = document.getElementById('userPartsViewContainer');
    
    try {
        const parts = await apiCall('parts.php');
        allUserParts = parts;
        
        if (parts.length === 0) {
            container.innerHTML = '<div class="notif">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø·Ø¹ ØºÙŠØ§Ø± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
            return;
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        updateUserPartsStats(parts);
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø·Ø¹
        displayUserPartsView(parts);
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±:', error);
        container.innerHTML = '<div class="notif">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±</div>';
    }
}

function updateUserPartsStats(parts) {
    const total = parts.length;
    const available = parts.filter(p => (parseInt(p.quantity) || 0) > 10).length;
    const low = parts.filter(p => {
        const qty = parseInt(p.quantity) || 0;
        return qty > 0 && qty <= 10;
    }).length;
    const unavailable = parts.filter(p => (parseInt(p.quantity) || 0) === 0).length;
    
    document.getElementById('userTotalParts').textContent = total;
    document.getElementById('userAvailableParts').textContent = available;
    document.getElementById('userLowParts').textContent = low;
    document.getElementById('userUnavailableParts').textContent = unavailable;
}

function displayUserPartsView(parts) {
    const container = document.getElementById('userPartsViewContainer');
    container.innerHTML = '';
    
    parts.forEach(part => {
        const quantity = parseInt(part.quantity) || 0;
        const status = getQuantityStatus(quantity);
        const lastUpdate = part.updated_at || part.created_at;
        
        const partCard = document.createElement('div');
        partCard.className = 'part-card';
        partCard.innerHTML = `
            <div class="part-card-header">
                <strong>${part.name}</strong>
                <span class="part-code">${part.code}</span>
            </div>
            <div class="part-quantity">${quantity} Ù‚Ø·Ø¹Ø©</div>
            <div class="quantity-status ${status.class}">${status.text}</div>
            <div style="margin-top: 10px; font-size: 0.8rem; color: #ccc;">
                <div>${part.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</div>
                <div style="margin-top: 5px; font-size: 0.7rem; opacity: 0.7;">
                    Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${formatDate(lastUpdate)}
                </div>
            </div>
        `;
        container.appendChild(partCard);
    });
}

function filterUserPartsFull() {
    const searchTerm = document.getElementById('userPartsSearchFull').value.toLowerCase().trim();
    
    if (!searchTerm) {
        displayUserPartsView(allUserParts);
        return;
    }
    
    const filteredParts = allUserParts.filter(part => 
        part.name.toLowerCase().includes(searchTerm) || 
        part.code.toLowerCase().includes(searchTerm) ||
        (part.description && part.description.toLowerCase().includes(searchTerm))
    );
    
    displayUserPartsView(filteredParts);
}

function formatDate(dateString) {
    if (!dateString) return 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
    
    const date = new Date(dateString);
    return date.toLocaleDateString('ar-SA');
}

function backToUserDashboard() {
    hideAllSections();
    userDashboard.classList.remove('hidden');
}

// ==================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø±Ù ====================
async function openBanks() { 
    hideAllSections(); 
    document.getElementById('banksSection').classList.remove('hidden'); 
    await renderBanks(); 
}

async function renderBanks() { 
    const tbody = document.querySelector('#banksTable tbody'); 
    tbody.innerHTML = ''; 
    
    try {
        showLoading(true);
        const banks = await apiCall('banks.php');
        
        if (banks.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±Ù Ù…Ø¶Ø§ÙØ© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td></tr>`;
            return;
        }
        
        banks.forEach((bank, index) => { 
            const tr = document.createElement('tr'); 
            tr.innerHTML = `
                <td>${bank.id}</td>
                <td>${bank.name}</td>
                <td>${bank.bank_key}</td>
                <td>
                    <button onclick="deleteBank(${bank.id})" class="small danger">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                </td>
            `; 
            tbody.appendChild(tr); 
        });
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ§Ø±Ù: ' + error.message);
    } finally {
        showLoading(false);
    }
}

async function addBank() { 
    const name = document.getElementById('bankNameIn').value.trim(); 
    const key = document.getElementById('bankKeyIn').value.trim(); 
    
    if (!name || !key) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        return;
    }

    try {
        showLoading(true);
        await apiCall('banks.php', 'POST', { name, key });
        document.getElementById('bankNameIn').value = '';
        document.getElementById('bankKeyIn').value = '';
        await renderBanks();
        alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±Ù Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±Ù: ' + error.message);
    } finally {
        showLoading(false);
    }
}

async function deleteBank(id) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙØŸ')) return;
    
    try {
        showLoading(true);
        await apiCall(`banks.php?id=${id}`, 'DELETE');
        await renderBanks();
        alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØµØ±Ù Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…ØµØ±Ù: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// ==================== Ø¥Ø¯Ø§Ø±Ø© Ø¢Ù„Ø§Øª Ø§Ù„Ø³Ø­Ø¨ ====================
async function openMachines() { 
    hideAllSections(); 
    document.getElementById('machinesSection').classList.remove('hidden'); 
    await renderMachines(); 
    await fillBranchSelects();
}

async function renderMachines() {
    const tbody = document.querySelector('#machinesTable tbody'); 
    tbody.innerHTML = ''; 
    
    try {
        showLoading(true);
        const machines = await apiCall('machines.php');
        
        if (machines.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¢Ù„Ø§Øª Ø³Ø­Ø¨ Ù…Ø¶Ø§ÙØ© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td></tr>`;
            return;
        }
        
        machines.forEach((machine, index) => { 
            const tr = document.createElement('tr'); 
            tr.innerHTML = `
                <td>${machine.id}</td>
                <td>${machine.machine_number}</td>
                <td>${machine.branch_name || ''}</td>
                <td>${machine.bank_key || ''}</td>
                <td>
                    <button onclick="deleteMachine(${machine.id})" class="small danger">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                </td>
            `; 
            tbody.appendChild(tr); 
        });
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ù„Ø§Øª Ø§Ù„Ø³Ø­Ø¨: ' + error.message);
    } finally {
        showLoading(false);
    }
}

async function fillBranchSelects() {
    const selects = document.querySelectorAll('#machineBranchIn');
    
    try {
        const banks = await apiCall('banks.php');
        
        selects.forEach(select => {
            const currentValue = select.value;
            select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹</option>';
            
            banks.forEach(bank => {
                const option = document.createElement('option');
                option.value = bank.id;
                option.textContent = bank.name;
                option.dataset.key = bank.bank_key;
                select.appendChild(option);
            });
            
            if (currentValue) {
                select.value = currentValue;
            }
        });
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ±ÙˆØ¹:', error);
    }
}

async function addMachine() {
    const machineNumber = document.getElementById('machineNumberIn').value.trim();
    const branchId = document.getElementById('machineBranchIn').value;
    
    if (!machineNumber || !branchId) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        return;
    }

    try {
        showLoading(true);
        await apiCall('machines.php', 'POST', { machine_number: machineNumber, branch_id: branchId });
        document.getElementById('machineNumberIn').value = '';
        document.getElementById('machineBranchIn').value = '';
        await renderMachines();
        alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¢Ù„Ø© Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø¢Ù„Ø© Ø§Ù„Ø³Ø­Ø¨: ' + error.message);
    } finally {
        showLoading(false);
    }
}

async function deleteMachine(machineId) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¢Ù„Ø©ØŸ')) return;
    
    try {
        showLoading(true);
        await apiCall(`machines.php?id=${machineId}`, 'DELETE');
        await renderMachines();
        alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¢Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¢Ù„Ø©: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// ==================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ====================
async function openUsers() { 
    hideAllSections(); 
    document.getElementById('usersSection').classList.remove('hidden'); 
    await renderUsers(); 
    await fillBranchesForUsers();
}

async function renderUsers() {
    const tbody = document.querySelector('#usersTable tbody'); 
    tbody.innerHTML = ''; 
    
    try {
        showLoading(true);
        const users = await apiCall('users.php');
        
        if (users.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¶Ø§ÙØ© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td></tr>`;
            return;
        }
        
        users.forEach((user, index) => { 
            const tr = document.createElement('tr'); 
            const userTypeClass = user.user_type === 'admin' ? 'user-type-admin' : 'user-type-user';
            
            tr.innerHTML = `
                <td>${user.id}</td>
                <td>${user.username}</td>
                <td>${user.branch_name || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</td>
                <td>
                    <span class="user-type-badge ${userTypeClass}">
                        ${user.user_type === 'admin' ? 'Ù…Ø³Ø¤ÙˆÙ„' : 'Ù…Ø³ØªØ®Ø¯Ù…'}
                    </span>
                </td>
                <td>${user.created_at}</td>
                <td>
                    <button onclick="editUser(${user.id})" class="small">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                    <button onclick="deleteUser(${user.id})" class="small danger">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                </td>
            `; 
            tbody.appendChild(tr); 
        });
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ' + error.message);
    } finally {
        showLoading(false);
    }
}

async function fillBranchesForUsers() {
    const select = document.getElementById('userBranchIn');
    
    try {
        const banks = await apiCall('banks.php');
        
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹</option>';
        
        banks.forEach(bank => {
            const option = document.createElement('option');
            option.value = bank.id;
            option.textContent = bank.name;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ±ÙˆØ¹:', error);
    }
}

async function addUser() {
    const username = document.getElementById('userNameIn').value.trim();
    const password = document.getElementById('userPassIn').value.trim();
    const userType = document.getElementById('userTypeIn').value;
    const branchId = document.getElementById('userBranchIn').value;
    
    if (!username || !password || !userType) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©');
        return;
    }

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠØŒ ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± ÙØ±Ø¹
    if (userType === 'user' && !branchId) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙØ±Ø¹ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ');
        return;
    }

    try {
        showLoading(true);
        await apiCall('users.php', 'POST', {
            username: username,
            password: password,
            user_type: userType,
            branch_id: userType === 'admin' ? null : branchId
        });
        
        // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        document.getElementById('userNameIn').value = '';
        document.getElementById('userPassIn').value = '';
        document.getElementById('userTypeIn').value = 'user';
        document.getElementById('userBranchIn').value = '';
        
        await renderUsers();
        alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + error.message);
    } finally {
        showLoading(false);
    }
}

async function editUser(userId) {
    try {
        showLoading(true);
        const users = await apiCall('users.php');
        const user = users.find(u => u.id === userId);
        
        if (!user) {
            alert('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        document.getElementById('userNameIn').value = user.username;
        document.getElementById('userTypeIn').value = user.user_type;
        document.getElementById('userBranchIn').value = user.branch_id || '';
        
        // ØªØºÙŠÙŠØ± Ù†Øµ Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        const addButton = document.querySelector('#usersSection button[onclick="addUser()"]');
        const originalText = addButton.textContent;
        addButton.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
        addButton.onclick = function() { updateUser(userId); };
        
        // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø¥Ù„ØºØ§Ø¡
        const cancelButton = document.createElement('button');
        cancelButton.textContent = 'âŒ Ø¥Ù„ØºØ§Ø¡';
        cancelButton.className = 'secondary';
        cancelButton.onclick = function() {
            resetUserForm();
            addButton.textContent = originalText;
            addButton.onclick = function() { addUser(); };
            cancelButton.remove();
        };
        
        document.querySelector('#usersSection .form-actions').appendChild(cancelButton);
        
        editingUserId = userId;
        
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + error.message);
    } finally {
        showLoading(false);
    }
}

async function updateUser(userId) {
    const username = document.getElementById('userNameIn').value.trim();
    const password = document.getElementById('userPassIn').value.trim();
    const userType = document.getElementById('userTypeIn').value;
    const branchId = document.getElementById('userBranchIn').value;
    
    if (!username || !userType) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©');
        return;
    }

    if (userType === 'user' && !branchId) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙØ±Ø¹ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ');
        return;
    }

    try {
        showLoading(true);
        const updateData = {
            username: username,
            user_type: userType,
            branch_id: userType === 'admin' ? null : branchId
        };
        
        // Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ø£Ø¶ÙÙ‡Ø§ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (password) {
            updateData.password = password;
        }
        
        await apiCall(`users.php?id=${userId}`, 'PUT', updateData);
        
        resetUserForm();
        await renderUsers();
        alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + error.message);
    } finally {
        showLoading(false);
    }
}

function resetUserForm() {
    document.getElementById('userNameIn').value = '';
    document.getElementById('userPassIn').value = '';
    document.getElementById('userTypeIn').value = 'user';
    document.getElementById('userBranchIn').value = '';
    
    const addButton = document.querySelector('#usersSection button[onclick="updateUser()"]');
    if (addButton) {
        addButton.textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…';
        addButton.onclick = function() { addUser(); };
    }
    
    const cancelButton = document.querySelector('#usersSection .form-actions button.secondary');
    if (cancelButton) {
        cancelButton.remove();
    }
    
    editingUserId = null;
}

async function deleteUser(userId) {
    if (userId === currentUser.id) {
        alert('âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ');
        return;
    }
    
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return;
    
    try {
        showLoading(true);
        await apiCall(`users.php?id=${userId}`, 'DELETE');
        await renderUsers();
        alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// ==================== Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± ====================
async function openParts() { 
    hideAllSections(); 
    document.getElementById('partsSection').classList.remove('hidden'); 
    await renderParts(); 
}

async function renderParts() {
    const tbody = document.querySelector('#partsTable tbody'); 
    tbody.innerHTML = ''; 
    
    try {
        showLoading(true);
        const parts = await apiCall('parts.php');
        
        if (parts.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø·Ø¹ ØºÙŠØ§Ø± Ù…Ø¶Ø§ÙØ© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td></tr>`;
            return;
        }
        
        parts.forEach((part, index) => { 
            const tr = document.createElement('tr'); 
            tr.innerHTML = `
                <td>${part.id}</td>
                <td>${part.code}</td>
                <td>${part.name}</td>
                <td>${part.quantity || 0}</td>
                <td>${part.created_at}</td>
                <td>
                    <button onclick="editPart(${part.id})" class="small">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                    <button onclick="deletePart(${part.id})" class="small danger">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                </td>
            `; 
            tbody.appendChild(tr); 
        });
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±: ' + error.message);
    } finally {
        showLoading(false);
    }
}

async function addPart() {
    const code = document.getElementById('partCodeIn').value.trim();
    const name = document.getElementById('partNameIn').value.trim();
    const quantity = parseInt(document.getElementById('partQuantityIn').value) || 0;
    
    if (!code || !name) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©');
        return;
    }

    try {
        showLoading(true);
        await apiCall('parts.php', 'POST', {
            code: code,
            name: name,
            quantity: quantity
        });
        
        // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        document.getElementById('partCodeIn').value = '';
        document.getElementById('partNameIn').value = '';
        document.getElementById('partQuantityIn').value = '';
        
        await renderParts();
        alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø± Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±: ' + error.message);
    } finally {
        showLoading(false);
    }
}

async function editPart(partId) {
    try {
        showLoading(true);
        const parts = await apiCall('parts.php');
        const part = parts.find(p => p.id === partId);
        
        if (!part) {
            alert('Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
            return;
        }
        
        // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        document.getElementById('partCodeIn').value = part.code;
        document.getElementById('partNameIn').value = part.name;
        document.getElementById('partQuantityIn').value = part.quantity || '';
        
        // ØªØºÙŠÙŠØ± Ù†Øµ Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        const addButton = document.querySelector('#partsSection button[onclick="addPart()"]');
        const originalText = addButton.textContent;
        addButton.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
        addButton.onclick = function() { updatePart(partId); };
        
        // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø¥Ù„ØºØ§Ø¡
        const cancelButton = document.createElement('button');
        cancelButton.textContent = 'âŒ Ø¥Ù„ØºØ§Ø¡';
        cancelButton.className = 'secondary';
        cancelButton.onclick = function() {
            resetPartForm();
            addButton.textContent = originalText;
            addButton.onclick = function() { addPart(); };
            cancelButton.remove();
        };
        
        document.querySelector('#partsSection .form-actions').appendChild(cancelButton);
        
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±: ' + error.message);
    } finally {
        showLoading(false);
    }
}

async function updatePart(partId) {
    const code = document.getElementById('partCodeIn').value.trim();
    const name = document.getElementById('partNameIn').value.trim();
    const quantity = parseInt(document.getElementById('partQuantityIn').value) || 0;
    
    if (!code || !name) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©');
        return;
    }

    try {
        showLoading(true);
        await apiCall(`parts.php?id=${partId}`, 'PUT', {
            code: code,
            name: name,
            quantity: quantity
        });
        
        resetPartForm();
        await renderParts();
        alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø± Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±: ' + error.message);
    } finally {
        showLoading(false);
    }
}

function resetPartForm() {
    document.getElementById('partCodeIn').value = '';
    document.getElementById('partNameIn').value = '';
    document.getElementById('partQuantityIn').value = '';
    
    const addButton = document.querySelector('#partsSection button[onclick="updatePart()"]');
    if (addButton) {
        addButton.textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹Ø©';
        addButton.onclick = function() { addPart(); };
    }
    
    const cancelButton = document.querySelector('#partsSection .form-actions button.secondary');
    if (cancelButton) {
        cancelButton.remove();
    }
}

async function deletePart(partId) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø± Ù‡Ø°Ù‡ØŸ')) return;
    
    try {
        showLoading(true);
        await apiCall(`parts.php?id=${partId}`, 'DELETE');
        await renderParts();
        alert('âœ… ØªÙ… Ø­Ø°Ù Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø± Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// ==================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± ====================
async function openInvoices() { 
    hideAllSections(); 
    document.getElementById('invoicesSection').classList.remove('hidden'); 
    await renderInvoices(); 
}

async function renderInvoices() {
    await renderPartsList();
    await fillMachineSelect();
    
    if (currentUser.user_type === 'admin') {
        document.getElementById('invoiceArea').classList.add('hidden');
        document.getElementById('adminInvoiceArea').classList.remove('hidden');
        await renderAdminInvoices();
        await renderAdminSavedInvoices();
    } else {
        document.getElementById('invoiceArea').classList.remove('hidden');
        document.getElementById('adminInvoiceArea').classList.add('hidden');
        await renderMyInvoices();
    }
    
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    document.getElementById('invDate').value = new Date().toISOString().split('T')[0];
}

async function renderPartsList() {
    const tbody = document.querySelector('#partsListTable tbody'); 
    tbody.innerHTML = ''; 
    
    try {
        const parts = await apiCall('parts.php');
        
        parts.forEach((part, index) => { 
            const tr = document.createElement('tr'); 
            tr.innerHTML = `
                <td>${part.code}</td>
                <td>${part.name}</td>
            `; 
            tbody.appendChild(tr); 
        });
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±:', error);
    }
}

async function fillMachineSelect() {
    const select = document.getElementById('invMachine');
    select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¢Ù„Ø© Ø§Ù„Ø³Ø­Ø¨</option>';
    
    try {
        let machines = [];
        
        if (currentUser.user_type === 'admin') {
            machines = await apiCall('machines.php');
        } else {
            const allMachines = await apiCall('machines.php');
            machines = allMachines.filter(machine => machine.branch_id == currentUser.branch_id);
        }
        
        machines.forEach(machine => {
            const option = document.createElement('option');
            option.value = machine.id;
            option.textContent = `${machine.machine_number} - ${machine.branch_name}`;
            select.appendChild(option);
        });
        
        if (machines.length === 0 && currentUser.user_type === 'user') {
            select.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¢Ù„Ø§Øª Ø³Ø­Ø¨ Ù…ØªØ§Ø­Ø© Ù„ÙØ±Ø¹Ùƒ</option>';
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¢Ù„Ø§Øª Ø§Ù„Ø³Ø­Ø¨:', error);
    }
}

async function invAutoFill() {
    const code = document.getElementById('invPartCode').value.trim();
    const nameInput = document.getElementById('invPartName');
    
    if (!code) {
        nameInput.value = '';
        return;
    }
    
    try {
        const parts = await apiCall('parts.php');
        const part = parts.find(p => p.code === code);
        
        if (part) {
            nameInput.value = part.name;
        } else {
            nameInput.value = '';
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù‚Ø·Ø¹Ø©:', error);
    }
}

async function sendInvoice() {
    const partCode = document.getElementById('invPartCode').value.trim();
    const partName = document.getElementById('invPartName').value.trim();
    const quantity = parseInt(document.getElementById('invQty').value) || 0;
    const date = document.getElementById('invDate').value;
    const machineId = document.getElementById('invMachine').value;
    
    if (!partCode || !partName || quantity <= 0 || !date || !machineId) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
        return;
    }

    try {
        showLoading(true);
        await apiCall('invoices.php', 'POST', {
            part_code: partCode,
            part_name: partName,
            quantity: quantity,
            date: date,
            machine_id: machineId,
            user_id: currentUser.id,
            status: 'pending'
        });
        
        // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        document.getElementById('invPartCode').value = '';
        document.getElementById('invPartName').value = '';
        document.getElementById('invQty').value = '';
        document.getElementById('invMachine').value = '';
        
        await renderInvoices();
        alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨: ' + error.message);
    } finally {
        showLoading(false);
    }
}

async function renderMyInvoices() {
    const tbody = document.querySelector('#myInvoicesTable tbody'); 
    tbody.innerHTML = ''; 
    
    try {
        const invoices = await apiCall('invoices.php');
        const myInvoices = invoices.filter(inv => inv.user_id == currentUser.id);
        
        if (myInvoices.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø¶Ø§ÙØ© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td></tr>`;
            return;
        }
        
        myInvoices.forEach((invoice, index) => { 
            const tr = document.createElement('tr'); 
            const statusClass = `invoice-status-${invoice.status}`;
            
            tr.innerHTML = `
                <td>${invoice.id}</td>
                <td>${invoice.part_code}</td>
                <td>${invoice.part_name}</td>
                <td>${invoice.quantity}</td>
                <td>${invoice.machine_number || ''}</td>
                <td>${invoice.date}</td>
                <td class="${statusClass}">
                    ${invoice.status === 'pending' ? 'â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' : 
                      invoice.status === 'approved' ? 'âœ… Ù…Ø¹ØªÙ…Ø¯Ø©' : 'âŒ Ù…Ø±ÙÙˆØ¶Ø©'}
                </td>
            `; 
            tbody.appendChild(tr); 
        });
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:', error);
    }
}

async function renderAdminInvoices() {
    const container = document.getElementById('adminInvoicesList');
    container.innerHTML = '';
    
    try {
        const invoices = await apiCall('invoices.php');
        const pendingInvoices = invoices.filter(inv => inv.status === 'pending');
        
        if (pendingInvoices.length === 0) {
            container.innerHTML = '<div class="notif">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© ØªØ­ØªØ§Ø¬ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div>';
            return;
        }
        
        pendingInvoices.forEach(invoice => {
            const div = document.createElement('div');
            div.className = 'notif';
            div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                    <div>
                        <strong>Ø·Ù„Ø¨ Ù…Ù†: ${invoice.username}</strong><br>
                        <small>Ø§Ù„Ù‚Ø·Ø¹Ø©: ${invoice.part_name} (${invoice.part_code}) - Ø§Ù„ÙƒÙ…ÙŠØ©: ${invoice.quantity}</small><br>
                        <small>Ø¢Ù„Ø© Ø§Ù„Ø³Ø­Ø¨: ${invoice.machine_number} - Ø§Ù„ØªØ§Ø±ÙŠØ®: ${invoice.date}</small>
                    </div>
                    <div class="flexrow">
                        <button class="small" onclick="approveInvoice(${invoice.id})">âœ… Ù‚Ø¨ÙˆÙ„</button>
                        <button class="small danger" onclick="rejectInvoice(${invoice.id})">âŒ Ø±ÙØ¶</button>
                    </div>
                </div>
            `;
            container.appendChild(div);
        });
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:', error);
    }
}

async function renderAdminSavedInvoices() {
    const tbody = document.querySelector('#adminSavedInvoices tbody'); 
    tbody.innerHTML = ''; 
    
    try {
        const invoices = await apiCall('invoices.php');
        
        if (invoices.length === 0) {
            tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø³Ø¬Ù„Ø©</td></tr>`;
            return;
        }
        
        invoices.forEach((invoice, index) => { 
            const tr = document.createElement('tr'); 
            const statusClass = `invoice-status-${invoice.status}`;
            
            tr.innerHTML = `
                <td>${invoice.id}</td>
                <td>${invoice.username}</td>
                <td>${invoice.part_code}</td>
                <td>${invoice.part_name}</td>
                <td>${invoice.quantity}</td>
                <td>${invoice.machine_number || ''}</td>
                <td>${invoice.date}</td>
                <td class="${statusClass}">
                    ${invoice.status === 'pending' ? 'â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' : 
                      invoice.status === 'approved' ? 'âœ… Ù…Ø¹ØªÙ…Ø¯Ø©' : 'âŒ Ù…Ø±ÙÙˆØ¶Ø©'}
                </td>
                <td>
                    ${invoice.status === 'pending' ? `
                        <button class="small" onclick="approveInvoice(${invoice.id})">âœ… Ù‚Ø¨ÙˆÙ„</button>
                        <button class="small danger" onclick="rejectInvoice(${invoice.id})">âŒ Ø±ÙØ¶</button>
                    ` : `
                        <button class="small secondary" onclick="deleteInvoice(${invoice.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                    `}
                </td>
            `; 
            tbody.appendChild(tr); 
        });
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:', error);
    }
}

async function approveInvoice(invoiceId) {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù‚Ø¨ÙˆÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ')) return;
    
    try {
        showLoading(true);
        await apiCall(`invoices.php?id=${invoiceId}`, 'PUT', { status: 'approved' });
        await renderInvoices();
        alert('âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨: ' + error.message);
    } finally {
        showLoading(false);
    }
}

async function rejectInvoice(invoiceId) {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø±ÙØ¶ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ')) return;
    
    try {
        showLoading(true);
        await apiCall(`invoices.php?id=${invoiceId}`, 'PUT', { status: 'rejected' });
        await renderInvoices();
        alert('âœ… ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨: ' + error.message);
    } finally {
        showLoading(false);
    }
}

async function deleteInvoice(invoiceId) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ')) return;
    
    try {
        showLoading(true);
        await apiCall(`invoices.php?id=${invoiceId}`, 'DELETE');
        await renderInvoices();
        alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// ==================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ====================
async function openNotifications() { 
    hideAllSections(); 
    document.getElementById('notificationsSection').classList.remove('hidden'); 
    await renderNotifications(); 
}

async function renderNotifications() {
    const container = document.getElementById('notificationsContainer');
    container.innerHTML = '';
    
    try {
        const notifications = await apiCall('notifications.php');
        
        if (notifications.length === 0) {
            container.innerHTML = '<div class="notif">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</div>';
            return;
        }
        
        notifications.forEach(notification => {
            const div = document.createElement('div');
            div.className = 'notif';
            div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap;">
                    <div style="flex: 1;">
                        <strong>${notification.title}</strong>
                        <p>${notification.message}</p>
                        <small>${notification.created_at}</small>
                    </div>
                    ${currentUser.user_type === 'admin' ? `
                        <button class="small danger" onclick="deleteNotification(${notification.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                    ` : ''}
                </div>
            `;
            container.appendChild(div);
        });
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:', error);
        container.innerHTML = '<div class="notif">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div>';
    }
}

async function deleteNotification(notificationId) {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±ØŸ')) return;
    
    try {
        showLoading(true);
        await apiCall(`notifications.php?id=${notificationId}`, 'DELETE');
        await renderNotifications();
        alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// ==================== Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ====================
async function openReports() { 
    hideAllSections(); 
    document.getElementById('reportsSection').classList.remove('hidden'); 
    await loadReportsData();
}

function showReportTab(tabName) {
    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    document.querySelectorAll('.report-section').forEach(section => {
        section.classList.add('hidden');
    });
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    document.querySelectorAll('.report-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­Ø¯Ø¯
    document.getElementById(tabName).classList.remove('hidden');
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø´Ø§Ø· Ù„Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­Ø¯Ø¯
    event.target.classList.add('active');
}

async function loadReportsData() {
    await loadPartsReport();
    await loadBranchesReport();
}

async function loadPartsReport() {
    try {
        showLoading(true);
        const parts = await apiCall('parts.php');
        const invoices = await apiCall('invoices.php');
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        const totalParts = parts.length;
        const totalQuantity = parts.reduce((sum, part) => sum + (parseInt(part.quantity) || 0), 0);
        const avgQuantity = totalParts > 0 ? (totalQuantity / totalParts).toFixed(1) : 0;
        
        document.getElementById('totalPartsCount').textContent = totalParts;
        document.getElementById('totalPartsQuantity').textContent = totalQuantity;
        document.getElementById('avgPartsQuantity').textContent = avgQuantity;
        
        // Ù…Ù„Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        const tbody = document.querySelector('#partsReportTable tbody');
        tbody.innerHTML = '';
        
        parts.forEach((part, index) => {
            const partInvoices = invoices.filter(inv => inv.part_code === part.code && inv.status === 'approved');
            const totalWithdrawn = partInvoices.reduce((sum, inv) => sum + (parseInt(inv.quantity) || 0), 0);
            const lastActivity = partInvoices.length > 0 ? 
                partInvoices[partInvoices.length - 1].date : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª';
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td>${part.code}</td>
                <td>${part.name}</td>
                <td>${part.quantity || 0}</td>
                <td>${totalWithdrawn}</td>
                <td>${lastActivity}</td>
            `;
            tbody.appendChild(tr);
        });
        
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±:', error);
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±');
    } finally {
        showLoading(false);
    }
}

async function loadBranchesReport() {
    try {
        showLoading(true);
        const banks = await apiCall('banks.php');
        const machines = await apiCall('machines.php');
        const invoices = await apiCall('invoices.php');
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        const totalBranches = banks.length;
        const totalInvoices = invoices.length;
        const avgInvoicesPerBranch = totalBranches > 0 ? (totalInvoices / totalBranches).toFixed(1) : 0;
        
        document.getElementById('totalBranchesCount').textContent = totalBranches;
        document.getElementById('totalInvoicesCount').textContent = totalInvoices;
        document.getElementById('avgInvoicesPerBranch').textContent = avgInvoicesPerBranch;
        
        // Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ±ÙˆØ¹
        const container = document.getElementById('branchesReportContainer');
        container.innerHTML = '';
        
        if (banks.length === 0) {
            container.innerHTML = '<div class="notif">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±ÙˆØ¹ Ù…Ø¶Ø§ÙØ© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</div>';
            return;
        }
        
        banks.forEach(bank => {
            const bankMachines = machines.filter(m => m.branch_id == bank.id);
            const bankInvoices = invoices.filter(inv => {
                const machine = machines.find(m => m.id == inv.machine_id);
                return machine && machine.branch_id == bank.id;
            });
            
            const approvedInvoices = bankInvoices.filter(inv => inv.status === 'approved');
            const pendingInvoices = bankInvoices.filter(inv => inv.status === 'pending');
            
            // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©
            const totalPartsUsed = approvedInvoices.reduce((sum, inv) => sum + (parseInt(inv.quantity) || 0), 0);
            
            // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø¢Ù„Ø§Øª Ø§Ù„ØªÙŠ ØªÙ…Øª ØµÙŠØ§Ù†ØªÙ‡Ø§
            const maintainedMachines = bankMachines.filter(machine => {
                const machineInvoices = bankInvoices.filter(inv => inv.machine_id == machine.id && inv.status === 'approved');
                return machineInvoices.length > 0;
            });
            
            const branchDiv = document.createElement('div');
            branchDiv.className = 'branch-report-details';
            branchDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                    <div>
                        <h4>${bank.name}</h4>
                        <p>Ù…ÙØªØ§Ø­ Ø§Ù„Ù…ØµØ±Ù: ${bank.bank_key}</p>
                    </div>
                    <div class="flexrow">
                        <button class="small" onclick="showBranchDetails(${bank.id})">ğŸ“Š ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ±Ø¹</button>
                    </div>
                </div>
                <div class="report-stats" style="margin: 10px 0;">
                    <div class="stat-card">
                        <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø¢Ù„Ø§Øª</div>
                        <div style="font-size: 1.2rem; font-weight: bold;">${bankMachines.length}</div>
                    </div>
                    <div class="stat-card">
                        <div>Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©</div>
                        <div style="font-size: 1.2rem; font-weight: bold; color: #00cc99;">${approvedInvoices.length}</div>
                    </div>
                    <div class="stat-card">
                        <div>Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</div>
                        <div style="font-size: 1.2rem; font-weight: bold; color: #ffa500;">${pendingInvoices.length}</div>
                    </div>
                    <div class="stat-card">
                        <div>Ø§Ù„Ø¢Ù„Ø§Øª Ø§Ù„Ù…Ø®Ø¯Ù…Ø©</div>
                        <div style="font-size: 1.2rem; font-weight: bold;">${maintainedMachines.length}/${bankMachines.length}</div>
                    </div>
                </div>
            `;
            container.appendChild(branchDiv);
        });
        
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ±ÙˆØ¹:', error);
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ±ÙˆØ¹');
    } finally {
        showLoading(false);
    }
}

// ==================== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ====================
function hideAllSections() {
    document.querySelectorAll('.section').forEach(section => {
        section.classList.add('hidden');
    });
}

function showLoading(show) {
    const loadingView = document.getElementById('loadingView');
    if (show) {
        loadingView.classList.remove('hidden');
    } else {
        loadingView.classList.add('hidden');
    }
}

function backToMain() {
    hideAllSections();
}

// ==================== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ====================
document.addEventListener('DOMContentLoaded', function() {
    // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
    setTimeout(() => {
        showLoading(false);
        loginView.classList.remove('hidden');
    }, 1000);
    
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('invDate').value = today;
});

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…Ø©
window.addEventListener('error', function(e) {
    console.error('Ø­Ø¯Ø« Ø®Ø·Ø£:', e.error);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.');
});
</script>
</body>
</html>